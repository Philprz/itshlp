<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Test API IT SPIRIT</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    select, input, button { padding: 10px; margin: 10px 0; width: 100%; }
    pre { background: #f0f0f0; padding: 10px; border-radius: 5px; overflow-x: auto; }
    .result-block { background: #fafafa; border-left: 4px solid #007acc; padding: 10px; margin-bottom: 1em; font-size: 0.95em; line-height: 1.5em; }
    .result-block p { white-space: pre-wrap; margin: 0.5em 0; }
    .gpt-response { background: #fff8e1; border-left: 5px solid #f4b400; }
    .gpt-response h3 { color: #bf9000; font-size: 1em; margin-top: 0; display: flex; justify-content: space-between; align-items: center; }
    .gpt-response button.copy-btn { font-size: 0.8em; padding: 4px 8px; background: #f4b400; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    #loader span::after {
      content: '';
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #007acc;
      animation: pulse 1s infinite;
      margin-left: 10px;
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.5); opacity: 0.5; }
      100% { transform: scale(1); opacity: 1; }
    }
  </style>
</head>
<body>
  <h1>Test API IT SPIRIT</h1>
  <div id="loader" style="display: none; text-align:center; margin: 20px 0;">
    <span style="font-size: 1.2em;">⏳ Analyse en cours... Veuillez patienter</span>
  </div>

  <label for="query">Requête :</label>
  <input type="text" id="query" placeholder="Entrez votre requête">

  <label for="client">Client :</label>
  <select id="client"><option value="">-- Aucun --</option></select>

  <label for="erp">ERP :</label>
  <select id="erp">
    <option value="">-- Aucun --</option>
    <option value="SAP">SAP</option>
    <option value="NetSuite">NetSuite</option>
  </select>

  <label for="format">Format :</label>
  <select id="format">
    <option value="Summary">Summary</option>
    <option value="Detail">Detail</option>
    <option value="Guide">Guide</option>
  </select>

  <label for="limit">Nombre de résultats :</label>
  <input type="number" id="limit" value="10">

  <button id="searchBtn">Rechercher</button>

  <div id="result">
    <h2>Résultats</h2>
    <pre id="output">Les résultats apparaîtront ici...</pre>
    <p id="results-count" style="font-weight:bold; margin-top: 1em;"></p>
  </div>

<script>
const BASE_URL = "https://testback-dutt.onrender.com";

document.addEventListener("DOMContentLoaded", async () => {
  try {
    const res = await fetch(`${BASE_URL}/api/clients`);
    const data = await res.json();
    const select = document.getElementById("client");
    (data.clients || []).forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      select.appendChild(opt);
    });
  } catch (e) {
    console.error("Erreur chargement clients", e);
  }
});

document.getElementById("searchBtn").addEventListener("click", async () => {
  const output = document.getElementById('output');
  output.innerHTML = "";
  document.getElementById("loader").style.display = "block";

  const query = document.getElementById('query').value;
  const client = document.getElementById('client').value;
  const erp = document.getElementById('erp').value;
  const format = document.getElementById('format').value;
  const limit = parseInt(document.getElementById('limit').value);

  const payload = {
    query, format, limit,
    client: client || undefined,
    erp: erp || undefined
  };

  try {
    const res = await fetch(`${BASE_URL}/api/search`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    document.getElementById("loader").style.display = "none";

    if (!data || !data.content) {
      output.innerHTML = `<p>⚠️ Aucun contenu reçu.</p>`;
      return;
    }

    function renderMeta(meta) {
      if (!meta) return "";
      let html = "<div style='font-size: 0.9em; margin-top: 0.5em;'>";
      if (meta.erp) html += `<p>🏷️ ERP : <strong>${meta.erp}</strong></p>`;
      if (meta.dateFilter?.gte) {
        const d = new Date(meta.dateFilter.gte * 1000).toLocaleDateString();
        html += `<p>⏱️ Créés après : <strong>${d}</strong></p>`;
      }
      return html + "</div>";
    }

    if (format === "Detail") {
      const isGPT = Array.isArray(data.content) && data.content.length === 1 && typeof data.content[0] === "string";
      const isStructured = Array.isArray(data.content) && typeof data.content[0] === "object";

      if (isGPT) {
        output.innerHTML = `
          <div class="result-block gpt-response">
            <h3>
              🧠 Résultat généré automatiquement
              <span>
                <button class="copy-btn" onclick="copyGPT()">📝 Copier</button>
                <a href="https://chat.openai.com/" target="_blank">🤖</a>
              </span>
            </h3>
            <p id="gpt-content">${data.content[0].replace(/\n/g, "<br>")}</p>
            ${renderMeta(data.meta)}
          </div>`;
        document.getElementById("results-count").innerText = `🧠 Résultat enrichi unique généré par GPT`;
        return;
      }

      if (isStructured) {
        output.innerHTML = data.content.map((entry, i) => {
          const isGPT = (entry.source === "GPT");
          const badge = isGPT
            ? `<span style="font-size:0.8em; background:#f4b400; color:white; padding:2px 6px; border-radius:4px;">🧠 source: GPT</span>`
            : `<span style="font-size:0.8em; background:#007acc; color:white; padding:2px 6px; border-radius:4px;">🔷 source: Ticket</span>`;

          return `
            <div class="result-block">
              <h3 style="display:flex; justify-content:space-between;">
                📌 ${entry.summary || `Ticket ${i + 1}`}
                ${badge}
              </h3>
              <p>
                👤 ${entry.assignee || "-"} |
                📅 ${entry.created || "?"} |
                🔄 ${entry.updated || "?"} |
                🗂️ ${entry.source || "-"} |
                ${entry.url ? `<a href="${entry.url}" target="_blank">🔗 lien</a>` : ""}
              </p>
            </div>`;
        }).join('');
        document.getElementById("results-count").innerText = `📋 ${data.content.length} ticket(s) listé(s)`;
        return;
      }

      output.innerHTML = `<div class="result-block">📭 Aucun ticket trouvé.</div>`;
      document.getElementById("results-count").innerText = `📭 Aucun résultat`;
      return;
    }

    if (format === "Summary" || format === "Guide") {
      const content = Array.isArray(data.content) ? data.content[0] : data.content;
      const isGPT = data.meta?.mode === "deepresearch";
      const badge = isGPT
        ? `<span style="font-size:0.8em; background:#f4b400; color:white; padding:2px 6px; border-radius:4px;">🧠 source: GPT</span>`
        : `<span style="font-size:0.8em; background:#007acc; color:white; padding:2px 6px; border-radius:4px;">📁 source: Tickets</span>`;

      const title = format === "Summary" ? "📝 Résumé global" : "🛠️ Guide pratique";

      output.innerHTML = `
        <div class="result-block">
          <h3 style="display:flex; justify-content:space-between;">
            ${title}
            ${badge}
          </h3>
          <p>${content.replace(/\n/g, "<br>")}</p>
          ${renderMeta(data.meta)}
        </div>
      `;

      document.getElementById("results-count").innerText = `🧮 Résultat ${format.toLowerCase()} affiché`;
      return;
    }

  } catch (err) {
    document.getElementById("loader").style.display = "none";
    output.innerHTML = `<p>❌ Erreur : ${err.message}</p>`;
  }
});

function copyGPT() {
  const el = document.getElementById("gpt-content");
  navigator.clipboard.writeText(el.innerText || el.textContent);
  alert("✅ Contenu copié !");
}
</script>
</body>
</html>
