<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Test API IT SPIRIT</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    select, input, button { padding: 10px; margin: 10px 0; width: 100%; }
    pre { background: #f0f0f0; padding: 10px; border-radius: 5px; overflow-x: auto; }
    .result-block { background: #fafafa; border-left: 4px solid #007acc; padding: 10px; margin-bottom: 1em; font-size: 0.95em; line-height: 1.5em; }
    .result-block p { white-space: pre-wrap; }
    .ticket-block ul { list-style: none; padding-left: 0; }
    .ticket-block ul li { margin-bottom: 4px; }
    #loader span::after {
      content: '';
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #007acc;
      animation: pulse 1s infinite;
      margin-left: 10px;
    }

    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.5); opacity: 0.5; }
      100% { transform: scale(1); opacity: 1; }
    }
  </style>
</head>
<body>
  <h1>Test API IT SPIRIT</h1>
  <div id="loader" style="display: none; text-align:center; margin: 20px 0;">
    <span style="font-size: 1.2em;">â³ Analyse en cours... Veuillez patienter</span>
  </div>
  
  <label for="query">RequÃªte :</label>
  <input type="text" id="query" placeholder="Entrez votre requÃªte">

  <label for="client">Client :</label>
  <select id="client">
    <option value="">-- Aucun --</option>
  </select>

  <label for="erp">ERP :</label>
  <select id="erp">
    <option value="">-- Aucun --</option>
    <option value="SAP">SAP</option>
    <option value="NetSuite">NetSuite</option>
  </select>

  <label for="format">Format :</label>
  <select id="format">
    <option value="Summary">Summary</option>
    <option value="Detail">Detail</option>
    <option value="Guide">Guide</option>
  </select>

  <label for="limit">Nombre de rÃ©sultats :</label>
  <input type="number" id="limit" value="10">

  <button id="searchBtn">Rechercher</button>

  <div id="result">
    <h2>RÃ©sultats</h2>
    <pre id="output">Les rÃ©sultats apparaÃ®tront ici...</pre>
    <p id="results-count" style="font-weight:bold; margin-top: 1em;"></p>
  </div>

  <script>
    const BASE_URL = "https://testback-dutt.onrender.com";

    async function loadClients() {
      try {
        const response = await fetch(`${BASE_URL}/api/clients`);
        const data = await response.json();
        const select = document.getElementById("client");

        if (!select) {
          console.warn("âš ï¸ Ã‰lÃ©ment <select id='client'> non trouvÃ© !");
          return;
        }

        if (data.clients && Array.isArray(data.clients)) {
          data.clients.forEach(client => {
            const opt = document.createElement("option");
            opt.value = client;
            opt.textContent = client;
            select.appendChild(opt);
          });
          console.log(`[âœ…] ${data.clients.length} clients chargÃ©s`);
        } else {
          console.warn("âš ï¸ DonnÃ©es clients mal formatÃ©es :", data);
        }
      } catch (e) {
        console.error("âŒ Erreur lors du chargement des clients", e);
      }
    }

    document.getElementById('searchBtn').addEventListener('click', async () => {
      const output = document.getElementById('output');
      output.innerHTML = "";
      document.getElementById("loader").style.display = "block";  // ğŸ”„ Affiche le loader

      const query = document.getElementById('query').value;
      const client = document.getElementById('client').value;
      const erp = document.getElementById('erp').value;
      const format = document.getElementById('format').value;
      const limit = parseInt(document.getElementById('limit').value);

      const payload = {
        query: query,
        client: client !== "" ? client : undefined,
        erp: erp !== "" ? erp : undefined,
        format: format,
        limit: limit
      };

      const baseBlock = document.createElement("div");
      baseBlock.className = "result-block";
      baseBlock.innerHTML = `
        <strong>ğŸ“¤ RequÃªte envoyÃ©e Ã  l'API :</strong><br>
        <pre>${JSON.stringify(payload, null, 2)}</pre>
        <p>ğŸ”¢ Nombre demandÃ© : ${limit}</p>
        <em>En attente de la rÃ©ponse...</em>
      `;
      output.appendChild(baseBlock);

      try {
        const response = await fetch(`${BASE_URL}/api/search`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });

        const data = await response.json();
        document.getElementById("loader").style.display = "none";  // âœ… Cache le loader
        console.log("[DEBUG] RÃ©ponse API:", data);

        if (!data || !data.content) {
          output.insertAdjacentHTML("beforeend", `<p>âš ï¸ Aucun contenu reÃ§u.</p>`);
          return;
        }

        function renderMeta(meta) {
            if (!meta) return "";

            let html = `<div style="font-size: 0.9em; margin-top: 0.5em;">`;

            if (meta.erp) {
                html += `<p>ğŸ·ï¸ ERP dÃ©tectÃ© : <strong>${meta.erp}</strong></p>`;
            }

            if (meta.dateFilter?.gte) {
                const date = new Date(meta.dateFilter.gte * 1000).toLocaleDateString();
                html += `<p>â±ï¸ Filtre sur les tickets crÃ©Ã©s aprÃ¨s : <strong>${date}</strong></p>`;
            }

            html += `</div>`;
            return html;
        }

        if (format === "Summary") {
            const summaryText = Array.isArray(data.content) ? data.content[0] : data.content;
            const sources = (data.sources || "").split(",").map(s => s.trim());
            const baseUrls = {
                "JIRA": "https://jira.exemple.com/",
                "ZENDESK": "https://zendesk.exemple.com/",
                "CONFLUENCE": "https://confluence.exemple.com/"
            };

            const sourcesLinks = sources.map(src => {
                const base = baseUrls[src.toUpperCase()];
                return base ? `<a href="${base}" target="_blank">${src}</a>` : src;
            }).join(', ');

            let extraInfo = "";
            if (data.meta) {
                if (data.meta.erp) extraInfo += `<p>ğŸ·ï¸ ERP dÃ©tectÃ© : <strong>${data.meta.erp}</strong></p>`;
                if (data.meta.dateFilter) {
                const timestamp = data.meta.dateFilter.gte;
                const date = new Date(timestamp * 1000).toLocaleDateString();
                extraInfo += `<p>â±ï¸ Filtre sur les tickets crÃ©Ã©s aprÃ¨s : <strong>${date}</strong></p>`;
                }
            }

            const summaryHtml = `
                <div class="result-block">
                <h3>ğŸ“ RÃ©sumÃ© global</h3>
                <p>${summaryText.replace(/\n/g, "<br>")}</p>
                <p>ğŸ“ Sources utilisÃ©es : ${sourcesLinks}</p>
                ${extraInfo}
                </div>
            `;
            output.insertAdjacentHTML("beforeend", summaryHtml);
            document.getElementById("results-count").innerText = `ğŸ§® Nombre de tickets rÃ©sumÃ©s : ${limit}`;
            return;
        }

        if (format === "Guide") {
            const guideHtml = Array.isArray(data.content)
                ? data.content.map((text, i) => `
                    <div class="result-block">
                        <h3>ğŸ› ï¸ Guide ${i + 1}</h3>
                        <p>${text.replace(/\n/g, "<br>")}</p>
                    </div>
                `).join('')
                : `
                    <div class="result-block">
                        <h3>ğŸ› ï¸ Guide</h3>
                        <p>${data.content.replace(/\n/g, "<br>")}</p>
                    </div>
                `;

            output.insertAdjacentHTML("beforeend", guideHtml);
            if (data.meta) output.insertAdjacentHTML("beforeend", renderMeta(data.meta));
            document.getElementById("results-count").innerText = `ğŸ§® Nombre de rÃ©sultats retournÃ©s : ${Array.isArray(data.content) ? data.content.length : 1}`;
            return;
        }

        if (format === "Detail") {
            const detailHtml = Array.isArray(data.content)
                ? data.content.map((entry, i) => {
                    return `
                    <div class="result-block ticket-block">
                      <h3>ğŸ“‹ ${entry.summary || `Ticket ${i + 1}`}</h3>
                      <ul>
                        <li><strong>ğŸ‘¤ AssignÃ© Ã  :</strong> ${entry.assignee || "Non dÃ©fini"}</li>
                        <li><strong>ğŸ“… CrÃ©Ã© le :</strong> ${entry.created || "?"}</li>
                        <li><strong>ğŸ”„ Mis Ã  jour le :</strong> ${entry.updated || "?"}</li>
                        <li><strong>ğŸ“ Source :</strong> ${entry.source || "?"}</li>
                        <li><strong>ğŸ¯ Score :</strong> ${entry.score !== null ? entry.score : "Non calculÃ©"}</li>
                        ${entry.url ? `<li><strong>ğŸ”— Lien :</strong> <a href="${entry.url}" target="_blank">Voir la source</a></li>` : ""}
                      </ul>
                    </div>
                    `;
                  }).join('')
                : `<div class="result-block"><p>${data.content}</p></div>`;

            output.innerHTML = detailHtml;
            document.getElementById("results-count").innerText = `ğŸ§® Nombre de rÃ©sultats retournÃ©s : ${Array.isArray(data.content) ? data.content.length : 1}`;
            return;
        }

        output.insertAdjacentHTML("beforeend", `<p>âš ï¸ Format de rÃ©ponse non reconnu.</p>`);

      } catch (error) {
        document.getElementById("loader").style.display = "none";  // âŒ Cache mÃªme en cas d'erreur
        console.error("[Erreur]", error);
        output.insertAdjacentHTML("beforeend", `<p>âŒ Erreur : ${error.message}</p>`);
      }
    });

    document.addEventListener("DOMContentLoaded", loadClients);
  </script>
</body>
</html>
