<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Test API Qdrant IT SPIRIT</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        select, input, button { padding: 10px; margin: 10px 0; width: 100%; }
        pre { background: #f0f0f0; padding: 10px; border-radius: 5px; }
        .result-block { margin-bottom:1em; border-bottom:1px solid #ccc; padding-bottom:1em; }
    </style>
</head>
<body>
    <h1>Test API Qdrant IT SPIRIT</h1>

    <label for="query">Requête :</label>
    <input type="text" id="query" placeholder="Entrez votre requête">

    <label for="client">Client :</label>
    <select id="client">
        <option value="">-- Aucun --</option>
    </select>

    <label for="erp">ERP :</label>
    <select id="erp">
        <option value="">-- Aucun --</option>
        <option value="SAP">SAP</option>
        <option value="NetSuite">NetSuite</option>
    </select>

    <label for="format">Format :</label>
    <select id="format">
        <option value="Summary">Summary</option>
        <option value="Detail">Detail</option>
        <option value="Guide">Guide</option>
    </select>

    <label for="limit">Nombre de résultats :</label>
    <input type="number" id="limit" value="10">

    <button id="searchBtn">Rechercher</button>

    <div id="result">
        <h2>Résultats</h2>
        <pre id="output">Les résultats apparaîtront ici...</pre>
    </div>

    <script>
    async function loadClients() {
        try {
            const response = await fetch("/api/clients");
            const data = await response.json();
            const select = document.getElementById("client");
            data.clients.forEach(client => {
                const opt = document.createElement("option");
                opt.value = client;
                opt.textContent = client;
                select.appendChild(opt);
            });
        } catch (e) {
            console.error("Erreur lors du chargement des clients", e);
        }
    }

    document.getElementById('searchBtn').addEventListener('click', async () => {
        const output = document.getElementById('output');
        output.textContent = 'Chargement...';

        const query = document.getElementById('query').value;
        const client = document.getElementById('client').value;
        const erp = document.getElementById('erp').value;
        const format = document.getElementById('format').value;
        const limit = parseInt(document.getElementById('limit').value);

        try {
            const response = await fetch('/api/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    query: query,
                    client: client || undefined,
                    erp: erp || undefined,
                    format: format,
                    limit: limit
                })
            });

            const data = await response.json();
            console.log("[DEBUG] Réponse API:", data);

            if (!data || !data.content) {
                output.textContent = "Aucun contenu reçu.";
                return;
            }

            if (Array.isArray(data.content) && typeof data.content[0] === 'string') {
                output.innerHTML = data.content.map((item, i) => `
                    <div class="result-block">
                        <strong>Résultat ${i + 1}</strong><br>
                        <p>${item.replace(/\n/g, '<br>')}</p>
                    </div>
                `).join('');
                return;
            }

            const htmlResults = data.content.map(item => {
                const color = item.color === "green" ? "🟢" : item.color === "orange" ? "🟠" : item.color === "red" ? "🔴" : "⚪";
                const link = item.url ? `<a href="${item.url}" target="_blank">🔗 Ouvrir</a>` : "Lien non disponible";
                return `
                    <div class="result-block">
                        <strong>${color} ${item.source || 'Source inconnue'}</strong> - Client : <em>${item.client || 'Non défini'}</em><br>
                        🕒 Créé le : ${item.created || 'N/A'} | 🛠️ MAJ : ${item.updated || 'N/A'}<br>
                        👷 Assigné à : ${item.assignee || 'N/A'}<br>
                        📄 <strong>${item.summary || 'Pas de résumé'}</strong><br>
                        ${link}<br>
                        <small>Score : ${item.score || 'N/A'}</small>
                    </div>
                `;
            }).join("");

            output.innerHTML = htmlResults;

        } catch (error) {
            console.error("[Erreur]", error);
            output.textContent = `Erreur : ${error.message}`;
        }
    });

    window.onload = loadClients;
    </script>
</body>
</html>
