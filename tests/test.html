<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Test API Qdrant IT SPIRIT</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    select, input, button { padding: 10px; margin: 10px 0; width: 100%; }
    pre { background: #f0f0f0; padding: 10px; border-radius: 5px; overflow-x: auto; }
    .result-block { margin-bottom:1em; border-bottom:1px solid #ccc; padding-bottom:1em; }
    h3 {
        margin-top: 1em;
        font-size: 1.1em;
        color: #333;
        }

        .result-block {
        background: #fafafa;
        border-left: 4px solid #007acc;
        padding: 10px;
        margin-bottom: 1em;
        font-size: 0.95em;
        line-height: 1.5em;
        }

        .result-block p {
        white-space: pre-wrap;
        }

  </style>
</head>
<body>
  <h1>Test API Qdrant IT SPIRIT</h1>

  <label for="query">Requ√™te :</label>
  <input type="text" id="query" placeholder="Entrez votre requ√™te">

  <label for="client">Client :</label>
  <select id="client">
    <option value="">-- Aucun --</option>
  </select>

  <label for="erp">ERP :</label>
  <select id="erp">
    <option value="">-- Aucun --</option>
    <option value="SAP">SAP</option>
    <option value="NetSuite">NetSuite</option>
  </select>

  <label for="format">Format :</label>
  <select id="format">
    <option value="Summary">Summary</option>
    <option value="Detail">Detail</option>
    <option value="Guide">Guide</option>
  </select>

  <label for="limit">Nombre de r√©sultats :</label>
  <input type="number" id="limit" value="10">

  <button id="searchBtn">Rechercher</button>

  <div id="result">
    <h2>R√©sultats</h2>
    <pre id="output">Les r√©sultats appara√Ætront ici...</pre>
    <p id="results-count" style="font-weight:bold; margin-top: 1em;"></p>

  </div>

  <script>
    const BASE_URL = "https://itshlp.onrender.com";

    async function loadClients() {
      try {
        const response = await fetch(`${BASE_URL}/api/clients`);
        const data = await response.json();
        const select = document.getElementById("client");

        if (!select) {
          console.warn("‚ö†Ô∏è √âl√©ment <select id='client'> non trouv√© !");
          return;
        }

        if (data.clients && Array.isArray(data.clients)) {
          data.clients.forEach(client => {
            const opt = document.createElement("option");
            opt.value = client;
            opt.textContent = client;
            select.appendChild(opt);
          });
          console.log(`[‚úÖ] ${data.clients.length} clients charg√©s`);
        } else {
          console.warn("‚ö†Ô∏è Donn√©es clients mal format√©es :", data);
        }
      } catch (e) {
        console.error("‚ùå Erreur lors du chargement des clients", e);
      }
    }

    document.getElementById('searchBtn').addEventListener('click', async () => {
      const output = document.getElementById('output');
      output.innerHTML = "";

      const query = document.getElementById('query').value;
      const client = document.getElementById('client').value;
      const erp = document.getElementById('erp').value;
      const format = document.getElementById('format').value;
      const limit = parseInt(document.getElementById('limit').value);

      const payload = {
        query: query,
        client: client !== "" ? client : undefined,
        erp: erp !== "" ? erp : undefined,
        format: format,
        limit: limit
      };

      const baseBlock = document.createElement("div");
      baseBlock.className = "result-block";
      baseBlock.innerHTML = `
        <strong>üì§ Requ√™te envoy√©e √† l'API :</strong><br>
        <pre>${JSON.stringify(payload, null, 2)}</pre>
        <p>üî¢ Nombre demand√© : ${limit}</p>
        <em>En attente de la r√©ponse...</em>
      `;
      output.appendChild(baseBlock);

      try {
        const response = await fetch(`${BASE_URL}/api/search`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });

        const data = await response.json();
        console.log("[DEBUG] R√©ponse API:", data);

        if (!data || !data.content) {
          output.insertAdjacentHTML("beforeend", `<p>‚ö†Ô∏è Aucun contenu re√ßu.</p>`);
          return;
        }
        function renderMeta(meta) {
            if (!meta) return "";

            let html = `<div style="font-size: 0.9em; margin-top: 0.5em;">`;

            if (meta.erp) {
                html += `<p>üè∑Ô∏è ERP d√©tect√© : <strong>${meta.erp}</strong></p>`;
            }

            if (meta.dateFilter?.gte) {
                const date = new Date(meta.dateFilter.gte * 1000).toLocaleDateString();
                html += `<p>‚è±Ô∏è Filtre sur les tickets cr√©√©s apr√®s : <strong>${date}</strong></p>`;
            }

            html += `</div>`;
            return html;
        }

        if (format === "Summary") {
            const summaryText = Array.isArray(data.content) ? data.content[0] : data.content;
            const sources = (data.sources || "").split(",").map(s => s.trim());
            const baseUrls = {
                "JIRA": "https://jira.exemple.com/",
                "ZENDESK": "https://zendesk.exemple.com/",
                "CONFLUENCE": "https://confluence.exemple.com/"
            };

            const sourcesLinks = sources.map(src => {
                const base = baseUrls[src.toUpperCase()];
                return base ? `<a href="${base}" target="_blank">${src}</a>` : src;
            }).join(', ');

            let extraInfo = "";
            if (data.meta) {
                if (data.meta.erp) extraInfo += `<p>üè∑Ô∏è ERP d√©tect√© : <strong>${data.meta.erp}</strong></p>`;
                if (data.meta.dateFilter) {
                const timestamp = data.meta.dateFilter.gte;
                const date = new Date(timestamp * 1000).toLocaleDateString();
                extraInfo += `<p>‚è±Ô∏è Filtre sur les tickets cr√©√©s apr√®s : <strong>${date}</strong></p>`;
                }
            }

            const summaryHtml = `
                <div class="result-block">
                <h3>üìù R√©sum√© global</h3>
                <p>${summaryText.replace(/\n/g, "<br>")}</p>
                <p>üìÅ Sources utilis√©es : ${sourcesLinks}</p>
                ${extraInfo}
                </div>
            `;
            output.insertAdjacentHTML("beforeend", summaryHtml);
            document.getElementById("results-count").innerText = `üßÆ Nombre de tickets r√©sum√©s : ${limit}`;
            return;
            }

        if (format === "Guide") {
            const guideHtml = Array.isArray(data.content)
                ? data.content.map((text, i) => `
                    <div class="result-block">
                        <h3>üõ†Ô∏è Guide ${i + 1}</h3>
                        <p>${text.replace(/\n/g, "<br>")}</p>
                    </div>
                `).join('')
                : `
                    <div class="result-block">
                        <h3>üõ†Ô∏è Guide</h3>
                        <p>${data.content.replace(/\n/g, "<br>")}</p>
                    </div>
                `;

            output.insertAdjacentHTML("beforeend", guideHtml);
            if (data.meta) output.insertAdjacentHTML("beforeend", renderMeta(data.meta));
            document.getElementById("results-count").innerText = `üßÆ Nombre de r√©sultats retourn√©s : ${Array.isArray(data.content) ? data.content.length : 1}`;
            return;
            }

        if (format === "Detail") {
            const detailHtml = Array.isArray(data.content)
                ? data.content.map((entry, i) => {
                    const text = typeof entry === "string" ? entry : JSON.stringify(entry, null, 2);
                    const url = entry.url ? `<p>üîó <a href="${entry.url}" target="_blank">Voir la source</a></p>` : "";
                    return `
                    <div class="result-block">
                        <h3>üìã D√©tail ${i + 1}</h3>
                        <p>${text.replace(/\n/g, "<br>")}</p>
                        ${url}
                    </div>
                    `;
                }).join('')
                : `
                <div class="result-block">
                    <h3>üìã D√©tail</h3>
                    <p>${data.content.replace(/\n/g, "<br>")}</p>
                </div>
                `;

            output.insertAdjacentHTML("beforeend", detailHtml);
            if (data.meta) output.insertAdjacentHTML("beforeend", renderMeta(data.meta));
            document.getElementById("results-count").innerText = `üßÆ Nombre de r√©sultats retourn√©s : ${Array.isArray(data.content) ? data.content.length : 1}`;
            return;
        }

        output.insertAdjacentHTML("beforeend", `<p>‚ö†Ô∏è Format de r√©ponse non reconnu.</p>`);

      } catch (error) {
        console.error("[Erreur]", error);
        output.insertAdjacentHTML("beforeend", `<p>‚ùå Erreur : ${error.message}</p>`);
      }
    });

    document.addEventListener("DOMContentLoaded", loadClients);
  </script>
</body>
</html>
